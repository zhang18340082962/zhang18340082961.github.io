{"title":"sql查询连续签到天数","uid":"1a3e4bd78f5e4ca42de4b5c02b9d4f86","slug":"sql查询连续签到天数","date":"2021-12-20T08:23:46.000Z","updated":"2022-04-03T06:06:49.495Z","comments":true,"path":"api/articles/sql查询连续签到天数.json","keywords":null,"cover":null,"content":"<p>先建表</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">create table user_attendence(\nuser_id bigint comment &#39;用户名&#39;, \ndate TIMESTAMP comment &#39;日期&#39; ,\nis_sign bigint comment &#39;是否登录，0为否，1为是&#39;);\n-- delete from user_attendence;</code></pre>\n<p>接下来用python自己导入随机数据,500个用户、时间2021-1-1~2021-5-5。</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">import pymysql\nimport pandas as pd\nfrom sqlalchemy import create_engine\nimport numpy as np\ndf &#x3D; pd.DataFrame()\ndate &#x3D; pd.date_range(&#39;2021-1-1&#39;,&#39;2021-5-5&#39;).strftime(&#39;%Y-%m-%d&#39;)\ndf[&quot;user_id&quot;]&#x3D;[i for i in np.arange(1,500)]*len(date)\ndf[&#39;date&#39;] &#x3D; [i for i in date]*len(np.arange(1,500))\ndf[&quot;is_sign&quot;] &#x3D; [np.random.choice([0,1]) for i in range(len(df))]\ndf &#x3D; df.sort_values(by&#x3D;[&#39;user_id&#39;,&#39;date&#39;],na_position&#x3D;&#39;first&#39;)\n#写入数据库\ncon &#x3D; &#39;mysql+pymysql:&#x2F;&#x2F;root:3333@localhost:3306&#x2F;supermanzwg?charset&#x3D;utf8&#39;\n#如果出现字符串编码错误记得在Navicat运行alter table 表名 convert to character set utf8mb4;\ndf.to_sql(name&#x3D;&#39;user_attendence&#39;,con&#x3D;con,if_exists&#x3D;&#39;append&#39;,index &#x3D; False)</code></pre>\n<p>#截至当前，每个用户已经连续签到的天数<br>查出最后一次不登录的日期，与当前日期进行比较，二者差值为几就是连续登录几天</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">select max(date) from user_attendence;</code></pre>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">select \nuser_id ,\nmax(date),\nDATEDIFF(&#39;2021-02-19&#39;,max(date)) as max_con_days\nfrom user_attendence \nwhere is_sign &#x3D; 0 \ngroup by user_id;</code></pre>\n<p>#计算有史以来用户最大连续签到天数；<br>对用户分组，按日期进行排序，排序序号为rank;<br>如果日期与序号的差值为相等，按这个差值进行分组并计数，取最大值</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">select \nuser_id\n,max(&#96;次数&#96;)  &#96;最大连续登陆天数&#96;\nfrom \n    (select user_id\n    ,date\n    ,a.date-a.rn diff\n    ,count(*) &#96;次数&#96;\n    from \n        (select \n        user_id\n        ,date,\n        row_number() over(partition by user_id order by date asc) rn\n        from user_attendence  \n        where is_sign &#x3D; 1\n        ) a \n    group by user_id,diff\n    ) b \ngroup by user_id order by max(&#96;次数&#96;) desc;</code></pre>","feature":true,"text":"先建表 create table user_attendence( user_id bigint comment &#39;用户名&#39;, date TIMESTAMP comment &#39;日期&#39; , is_sign bigint comment &#39;是否...","link":"","photos":[],"count_time":{"symbolsCount":"1.8k","symbolsTime":"2 mins."},"categories":[],"tags":[{"name":"数据分析","slug":"数据分析","count":18,"path":"api/tags/数据分析.json"}],"toc":"","author":{"name":"弦好想断","slug":"blog-author","avatar":"D:\\blog\\public\\avatar.jpg","link":"/","description":"处女座男生，热爱技术、吉他、旅行。","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"sql排名函数","uid":"68c9396da13a152d585d7816d6c82312","slug":"sql排名函数","date":"2021-12-23T03:14:23.000Z","updated":"2022-04-03T06:06:41.689Z","comments":true,"path":"api/articles/sql排名函数.json","keywords":null,"cover":null,"text":" rank()排名是不连续的，出现同名的排序序号会相同(比较常规的排序)，存在并列，且序号会跳跃 适合求第一名，名次这类 select employee_id ,last_name ,department_id ,salary ,rank() over(partition by ...","link":"","photos":[],"count_time":{"symbolsCount":783,"symbolsTime":"1 mins."},"categories":[],"tags":[{"name":"数据分析","slug":"数据分析","count":18,"path":"api/tags/数据分析.json"}],"author":{"name":"弦好想断","slug":"blog-author","avatar":"D:\\blog\\public\\avatar.jpg","link":"/","description":"处女座男生，热爱技术、吉他、旅行。","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"feature":true},"next_post":{"title":"mysql_tips","uid":"a556aaed3b3be5cc651b39ff50e6148d","slug":"mysql-tips","date":"2021-12-13T08:35:58.000Z","updated":"2022-04-03T06:06:03.198Z","comments":true,"path":"api/articles/mysql-tips.json","keywords":null,"cover":null,"text":" 四个在工作后才知道的SQL密技 https://zhuanlan.zhihu.com/p/412878736 mysql基础https://blog.csdn.net/weixin_45108087/article/details/102766281 MYSQL中的COLLAT...","link":"","photos":[],"count_time":{"symbolsCount":"1.6k","symbolsTime":"1 mins."},"categories":[],"tags":[{"name":"数据分析","slug":"数据分析","count":18,"path":"api/tags/数据分析.json"}],"author":{"name":"弦好想断","slug":"blog-author","avatar":"D:\\blog\\public\\avatar.jpg","link":"/","description":"处女座男生，热爱技术、吉他、旅行。","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}}}